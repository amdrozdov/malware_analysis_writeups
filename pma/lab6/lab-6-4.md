# 6-4 Analysis
### Virus Total Search
**Name**: Trojan:Win32/Generic.78682e8f

**Compilation**: Compiler: EP:Microsoft Visual C/C++ 6.0EXE32

### 1-2 Difference and new code added to main
Here we can see for loop in the function after connection check:
```asm
.text:00401230                 push    ebp
.text:00401231                 mov     ebp, esp
.text:00401233                 sub     esp, 0Ch
.text:00401236                 call    connect_check
.text:0040123B                 mov     [ebp+var_4], eax
.text:0040123E                 cmp     [ebp+var_4], 0
.text:00401242                 jnz     short loc_401248
loc_401248:                             ; CODE XREF: sub_401230+12↑j
.text:00401248                 mov     [ebp+var_C], 0
.text:0040124F                 jmp     short loc_40125A
...
; command execution
jmp     short loc_401251 ;jump to the new iteration
...
 loc_401251:                             ; CODE XREF: sub_401230+7D↓j
.text:00401251                 mov     eax, [ebp+var_C]
.text:00401254                 add     eax, 1
.text:00401257                 mov     [ebp+var_C], eax
```
It means that the software will perform multiple actions on the host system and will perform Sleep() for 60 seconds between every action

### ParseHTML function difference
We can see sprintf template `Internet Explorer 7.50/pma%d` in command extraction subroutine:
```asm
.text:00401043                 sub     esp, 230h
.text:00401049                 mov     eax, [ebp+arg_0]
.text:0040104C                 push    eax
.text:0040104D                 push    offset aInternetExplor ; "Internet Explorer 7.50/pma%d"
.text:00401052                 lea     ecx, [ebp+szAgent]
.text:00401055                 push    ecx
.text:00401056                 call    sub_4012E6
.text:0040105B                 add     esp, 0Ch
.text:0040105E                 push    0               ; dwFlags
.text:00401060                 push    0               ; lpszProxyBypass
.text:00401062                 push    0               ; lpszProxy
.text:00401064                 push    0               ; dwAccessType
.text:00401066                 lea     edx, [ebp+szAgent]
.text:00401069                 push    edx             ; lpszAgent
.text:0040106A                 call    ds:InternetOpenA
```
### How long this programm will run?
If it will be added to autorun - the programm will get new command every 60 seconds and will run forever. But this for loop is limited with the constant 1440:
```asm
.text:00401251 loc_401251:                             ; CODE XREF: sub_401230+7D↓j
.text:00401251                 mov     eax, [ebp+var_C]
.text:00401254                 add     eax, 1
.text:00401257                 mov     [ebp+var_C], eax
.text:0040125A
.text:0040125A loc_40125A:                             ; CODE XREF: sub_401230+1F↑j
.text:0040125A                 cmp     [ebp+var_C], 5A0h
.text:00401261                 jge     short loc_4012AF
```
Programm will stop aster 1440 iterations = 60 sec * 1440 = 24 Hours
### Network based indicators
Every 60 seconds HTTP request to `http://www.practicalmalwareanalysis.com/cc.htm` with user agent `Internet Explorer 7.50/pma%d`
### Purpose of this malware?
1. Check internet
2. Perform HTTP request to remote server
3. Parse the command from remote server
4. Execute one of the following commands:
* `CreateDirectoryA` to create "C:\Temp" directory                              
* `CopyFileA` in order to drop a file in the filesystem: into "C:\Temp\cc.exe" - it means copy himself to this location
* `DeleteFileA` - Remove target file from the system                            
* `RegSetValueExA` - Set new key in the windows registry                        
* `Sleep` 100 seconds
5. Sleep 60 seconds
6. Repeat this process 1440 times (24 hours)

This looks like a demo of a simple trojan from real life.

**Total score**: 9/10
