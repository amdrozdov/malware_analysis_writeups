# Trojan-Ransom.Win32.Fixer.a Analysis
Samples in PMA book are a bit outdated - I'm using some real malware, that we can run at least on win7. This is original version of `Trojan-Ransom.Win32.Fixer.a`. I found it on [any.run](http://any.run/) daily public submissions

### Checksums
#### SHA256
`25f1979680c26601156c6ba3ad931b555b3f1ce82bf3546f8bf7d6241d3962d8  installer.exe`
#### MD5
`d70754abc051edb0248b7287834808e2  installer.exe`

### Obfuscation

DIE analysis

```
Installer: Inno Setup Module(5.1.7)[-]
Compiler: Borland Delphi(2)[-]
Linker: Turbo Linker(2.25*,Delphi)[GUI32]
Overlay: Inno Setup Installer data(-)[-]
Overlay: Binary
Data: Inno Setup Installer data
```

It was compiled with Borland Delphi (most probably fake)
```
% r2 installer.exe 
[0x004098bc]> aaa
[x] Analyze all flags starting with sym. and entry0 (aa)
[x] Analyze len bytes of instructions for references (aar)
[x] Analyze function calls (aac)
[x] Use -AA or aaaa to perform additional experimental analysis.
[x] Constructing a function name for fcn.* and sym.func.* functions (aan)
```

Some functions are not available for the analysis in r2. But we can see them all in IDA. Looks like some king of custom packaging

### Imports analysis

Strings analysis will not show anything interesting:

```
strings installer.exe
...
TObject
u:hD
SVWUQ
Z]_^[
SVWU
YZ]_^[
SVWU
]_^[
SVWU
w;;t$
]_^[
SVWU
]_^[
SVWUQ
Z]_^[
SVWU
YZ]_^[
SVWU
uW;{
u:;{
]_^[
ZYYd
SVWU
YZ]_^[
....
```

Imports:
```
[0x004098bc]> ii
[Imports]
   1 0x0040c0b4    NONE    FUNC kernel32.dll_DeleteCriticalSection
   2 0x0040c0b8    NONE    FUNC kernel32.dll_LeaveCriticalSection
   3 0x0040c0bc    NONE    FUNC kernel32.dll_EnterCriticalSection
   4 0x0040c0c0    NONE    FUNC kernel32.dll_InitializeCriticalSection
   5 0x0040c0c4    NONE    FUNC kernel32.dll_VirtualFree
   6 0x0040c0c8    NONE    FUNC kernel32.dll_VirtualAlloc
   7 0x0040c0cc    NONE    FUNC kernel32.dll_LocalFree
   8 0x0040c0d0    NONE    FUNC kernel32.dll_LocalAlloc
   9 0x0040c0d4    NONE    FUNC kernel32.dll_WideCharToMultiByte
  10 0x0040c0d8    NONE    FUNC kernel32.dll_TlsSetValue
  11 0x0040c0dc    NONE    FUNC kernel32.dll_TlsGetValue
  12 0x0040c0e0    NONE    FUNC kernel32.dll_MultiByteToWideChar
  13 0x0040c0e4    NONE    FUNC kernel32.dll_GetModuleHandleA
  14 0x0040c0e8    NONE    FUNC kernel32.dll_GetLastError
  15 0x0040c0ec    NONE    FUNC kernel32.dll_GetCommandLineA
  16 0x0040c0f0    NONE    FUNC kernel32.dll_WriteFile
  17 0x0040c0f4    NONE    FUNC kernel32.dll_SetFilePointer
  18 0x0040c0f8    NONE    FUNC kernel32.dll_SetEndOfFile
  19 0x0040c0fc    NONE    FUNC kernel32.dll_RtlUnwind
  20 0x0040c100    NONE    FUNC kernel32.dll_ReadFile
  21 0x0040c104    NONE    FUNC kernel32.dll_RaiseException
  22 0x0040c108    NONE    FUNC kernel32.dll_GetStdHandle
  23 0x0040c10c    NONE    FUNC kernel32.dll_GetFileSize
  24 0x0040c110    NONE    FUNC kernel32.dll_GetSystemTime
  25 0x0040c114    NONE    FUNC kernel32.dll_GetFileType
  26 0x0040c118    NONE    FUNC kernel32.dll_ExitProcess
  27 0x0040c11c    NONE    FUNC kernel32.dll_CreateFileA
  28 0x0040c120    NONE    FUNC kernel32.dll_CloseHandle
   1 0x0040c128    NONE    FUNC user32.dll_MessageBoxA
   1 0x0040c130    NONE    FUNC oleaut32.dll_VariantChangeTypeEx
   2 0x0040c134    NONE    FUNC oleaut32.dll_VariantCopyInd
   3 0x0040c138    NONE    FUNC oleaut32.dll_VariantClear
   4 0x0040c13c    NONE    FUNC oleaut32.dll_SysStringLen
   5 0x0040c140    NONE    FUNC oleaut32.dll_SysAllocStringLen
   1 0x0040c148    NONE    FUNC advapi32.dll_RegQueryValueExA
   2 0x0040c14c    NONE    FUNC advapi32.dll_RegOpenKeyExA
   3 0x0040c150    NONE    FUNC advapi32.dll_RegCloseKey
   4 0x0040c154    NONE    FUNC advapi32.dll_OpenProcessToken
   5 0x0040c158    NONE    FUNC advapi32.dll_LookupPrivilegeValueA
   1 0x0040c0f0    NONE    FUNC kernel32.dll_WriteFile
   2 0x0040c164    NONE    FUNC kernel32.dll_VirtualQuery
   3 0x0040c168    NONE    FUNC kernel32.dll_VirtualProtect
   4 0x0040c0c4    NONE    FUNC kernel32.dll_VirtualFree
   5 0x0040c0c8    NONE    FUNC kernel32.dll_VirtualAlloc
   6 0x0040c174    NONE    FUNC kernel32.dll_Sleep
   7 0x0040c178    NONE    FUNC kernel32.dll_SizeofResource
   8 0x0040c17c    NONE    FUNC kernel32.dll_SetLastError
   9 0x0040c0f4    NONE    FUNC kernel32.dll_SetFilePointer
  10 0x0040c184    NONE    FUNC kernel32.dll_SetErrorMode
  11 0x0040c0f8    NONE    FUNC kernel32.dll_SetEndOfFile
  12 0x0040c18c    NONE    FUNC kernel32.dll_RemoveDirectoryA
  13 0x0040c100    NONE    FUNC kernel32.dll_ReadFile
  14 0x0040c194    NONE    FUNC kernel32.dll_LockResource
  15 0x0040c198    NONE    FUNC kernel32.dll_LoadResource
  16 0x0040c19c    NONE    FUNC kernel32.dll_LoadLibraryA
  17 0x0040c1a0    NONE    FUNC kernel32.dll_IsDBCSLeadByte
  18 0x0040c1a4    NONE    FUNC kernel32.dll_GetWindowsDirectoryA
  19 0x0040c1a8    NONE    FUNC kernel32.dll_GetVersionExA
  20 0x0040c1ac    NONE    FUNC kernel32.dll_GetUserDefaultLangID
  21 0x0040c1b0    NONE    FUNC kernel32.dll_GetSystemInfo
  22 0x0040c1b4    NONE    FUNC kernel32.dll_GetSystemDefaultLCID
  23 0x0040c1b8    NONE    FUNC kernel32.dll_GetProcAddress
  24 0x0040c0e4    NONE    FUNC kernel32.dll_GetModuleHandleA
  25 0x0040c1c0    NONE    FUNC kernel32.dll_GetModuleFileNameA
  26 0x0040c1c4    NONE    FUNC kernel32.dll_GetLocaleInfoA
  27 0x0040c0e8    NONE    FUNC kernel32.dll_GetLastError
  28 0x0040c1cc    NONE    FUNC kernel32.dll_GetFullPathNameA
  29 0x0040c10c    NONE    FUNC kernel32.dll_GetFileSize
  30 0x0040c1d4    NONE    FUNC kernel32.dll_GetFileAttributesA
  31 0x0040c1d8    NONE    FUNC kernel32.dll_GetExitCodeProcess
  32 0x0040c1dc    NONE    FUNC kernel32.dll_GetEnvironmentVariableA
  33 0x0040c1e0    NONE    FUNC kernel32.dll_GetCurrentProcess
  34 0x0040c0ec    NONE    FUNC kernel32.dll_GetCommandLineA
  35 0x0040c1e8    NONE    FUNC kernel32.dll_GetACP
  36 0x0040c1ec    NONE    FUNC kernel32.dll_InterlockedExchange
  37 0x0040c1f0    NONE    FUNC kernel32.dll_FormatMessageA
  38 0x0040c1f4    NONE    FUNC kernel32.dll_FindResourceA
  39 0x0040c1f8    NONE    FUNC kernel32.dll_DeleteFileA
  40 0x0040c1fc    NONE    FUNC kernel32.dll_CreateProcessA
  41 0x0040c11c    NONE    FUNC kernel32.dll_CreateFileA
  42 0x0040c204    NONE    FUNC kernel32.dll_CreateDirectoryA
  43 0x0040c120    NONE    FUNC kernel32.dll_CloseHandle
   1 0x0040c210    NONE    FUNC user32.dll_TranslateMessage
   2 0x0040c214    NONE    FUNC user32.dll_SetWindowLongA
   3 0x0040c218    NONE    FUNC user32.dll_PeekMessageA
   4 0x0040c21c    NONE    FUNC user32.dll_MsgWaitForMultipleObjects
   5 0x0040c128    NONE    FUNC user32.dll_MessageBoxA
   6 0x0040c224    NONE    FUNC user32.dll_LoadStringA
   7 0x0040c228    NONE    FUNC user32.dll_ExitWindowsEx
   8 0x0040c22c    NONE    FUNC user32.dll_DispatchMessageA
   9 0x0040c230    NONE    FUNC user32.dll_DestroyWindow
  10 0x0040c234    NONE    FUNC user32.dll_CreateWindowExA
  11 0x0040c238    NONE    FUNC user32.dll_CallWindowProcA
  12 0x0040c23c    NONE    FUNC user32.dll_CharPrevA
   1 0x0040c244    NONE    FUNC comctl32.dll_InitCommonControls
   1 0x0040c24c    NONE    FUNC advapi32.dll_AdjustTokenPrivileges
```

Interesting ones:
*  `0x0040c24c    NONE    FUNC advapi32.dll_AdjustTokenPrivileges`
* `0x0040c1fc    NONE    FUNC kernel32.dll_CreateProcessA`
* `0x0040c11c    NONE    FUNC kernel32.dll_CreateFileA`
*  `0x0040c0f0    NONE    FUNC kernel32.dll_WriteFile`
*  `0x0040c11c    NONE    FUNC kernel32.dll_CreateFileA`

We can observe file manipulations, priviliges escalation.

In addition we can see import and sub function `0x00404574    1 6            sub.user32.dll_TranslateMessage_574` - looks like it will try to check language and show a message on right language?

Additional notes from static analysis:
It will reuse string `Inno Setup Setup Data (5.1.7)`

Some functions are unavailable in r2, will return following message
```
[0x004098bc]> pdf @0x00403604
p: Cannot find function at 0x00403604
```
But most of them are available for the analysis.

Fake compilation time
```
[0x004098bc]> ia
arch     x86
binsz    466726
bintype  pe
bits     32
canary   false
class    PE32
cmp.csum 0x0007ac2a
compiled Sat Jun 20 00:22:17 1992
```

### Host markers / Network activity

**Host markers**

* FILE `C:\Program Files\FileFix Professional 2009\wizard.exe`
* FILE `C:\Windows\System32\sechost.dll`
* FILE `C:\Windows\System32\apphelp.dll`
* ?FILE `C:\Windows\AppPatch\AcGenral.dll`
* ?FILE `C:\Windows\system32\ntkrnlpa.exe`
* ?FILE `C:\Windows\System32\sspicli.dll`
* ?FILE `C:\Windows\System32\uxtheme.dll`
* ?FILE `C:\Windows\System32\winmm.dll`
* ?FILE `C:\Windows\System32\samcli.dll`
* ?FILE `C:\Windows\System32\msacm32.dll`
* ?FILE `C:\Windows\System32\version.dll`
* ?FILE `C:\Windows\System32\sfc.dll`
* ?FILE `C:\Windows\System32\sfc_os.dll`
* ?FILE `C:\Windows\System32\userenv.dll`
* ?FILE `C:\Windows\System32\profapi.dll`
* ?FILE `C:\Windows\System32\dwmapi.dll`
* ?FILE `C:\Windows\System32\mpr.dll`
* ?FILE `C:\Windows\System32\imm32.dll`
* ?FILE `C:\Windows\WindowsShell.Manifest`
* ?FILE `C:\Windows\System32\en-US\setupapi.dll.mui`
* ?FILE `C:\Windows\System32\en-US\KernelBase.dll.mui`
* ?FILE `C:\Windows\System32\netmsg.dll`

**Reg reads**

* `HKCU\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags` application compatibility checks
* `HKCU\Control Panel\Desktop\MuiCached\MachineLanguageConfiguration` find available languages
*  `HKLM\System\CurrentControlSet\Control\Nls\CustomLocale\en-US` - after language detection it will read additional reg keys
*  Autp boot addition `HKLM\System\CurrentControlSet\Control\SafeBoot\Option`
*  `HKCU\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\{90311299-c714-4367-be12-032f464885b2}` extra key in app compat flags for custom locale?

**Netwrok Activity**

During dynamic analysis we can observe multiple TCP connections including:
```
23.15.179.146	a1363.dscg.akamai.net
87.248.222.128	windowsupdatebg.s.llnwi.net
216.58.213.78	www3.l.google.com
23.15.179.154	a1363.dscg.akamai.net
93.184.220.29	cs9.wac.phicdn.net
95.140.239.0	windowsupdatebg.s.llnwi.net
52.167.17.97	settings-prod-eus2-2.eastus2.cloudapp.azure.com
```

**Conclusion**

We can see that the installer drops additional file and checks language locale + there are TCP connections to wired resources. But I was not eble to see any ransomeware activity (probably because I don't have MS word on LAB VM). Main conclusion - joined viruses analysis is much harder + this one was "integrated" with installer and "wizzard like" software. Anyway it looks like a trojan (drop file, additional connections + boot reg).

**Epilogue**

According to the public reports - this virus is using complex schema for the infection process:
https://app.any.run/tasks/fde221b9-ae06-40f4-8fa6-526f97ecad70/#

But it was a nice try, at least I found main entries + dropped file
