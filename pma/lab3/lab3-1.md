# HEUR:Trojan-Spy.Win32.Stealer.gen Analysis
Samples in PMA book are a bit outdated - I'm using some real malware, that we can run at least on win7. This is original version of `HEUR:Trojan-Spy.Win32.Stealer.gen`. I found it on [any.run](http://any.run)

### Obfuscation
DIE analysis:
```
Compiler: MinGW(GCC: (GNU) 6.3.0)[-]
Linker: GNU linker ld (GNU Binutils)(2.28)[Console32,console,signed]
Overlay: Binary
```
Static analysis show error `Unknown DW_FORM 0x00`. After analysis it wil detect all sections correctly. [Maybe] No obfesccation - or just compression.
```
 % r2 crack.bin
Unknown DW_FORM 0x00
[0x004012e0]> aaa
[ WARNING : block size exceeding max block size at 0x00404fa0
[+] Try changing it with e anal.bb.maxsize
 WARNING : block size exceeding max block size at 0x00424128
[+] Try changing it with e anal.bb.maxsize
 WARNING : block size exceeding max block size at 0x00408886
[+] Try changing it with e anal.bb.maxsize
[x] Analyze all flags starting with sym. and entry0 (aa)
[x] Analyze len bytes of instructions for references (aar)
[x] Analyze function calls (aac)
[x] Use -AA or aaaa to perform additional experimental analysis.
[x] Constructing a function name for fcn.* and sym.func.* functions (aan)
```
### Imports analysis
Imports table:
```asm
[0x004012e0]> ii
[Imports]
   1 0x0050e21c    NONE    FUNC KERNEL32.dll_CloseHandle
   2 0x0050e220    NONE    FUNC KERNEL32.dll_CreateSemaphoreW
   3 0x0050e224    NONE    FUNC KERNEL32.dll_CreateThread
   4 0x0050e228    NONE    FUNC KERNEL32.dll_DeleteCriticalSection
   5 0x0050e22c    NONE    FUNC KERNEL32.dll_EnterCriticalSection
   6 0x0050e230    NONE    FUNC KERNEL32.dll_ExitProcess
   7 0x0050e234    NONE    FUNC KERNEL32.dll_FindClose
   8 0x0050e238    NONE    FUNC KERNEL32.dll_FindFirstFileA
   9 0x0050e23c    NONE    FUNC KERNEL32.dll_FindNextFileA
  10 0x0050e240    NONE    FUNC KERNEL32.dll_FreeLibrary
  11 0x0050e244    NONE    FUNC KERNEL32.dll_GetCommandLineA
  12 0x0050e248    NONE    FUNC KERNEL32.dll_GetCurrentProcess
  13 0x0050e24c    NONE    FUNC KERNEL32.dll_GetCurrentThread
  14 0x0050e250    NONE    FUNC KERNEL32.dll_GetCurrentThreadId
  15 0x0050e254    NONE    FUNC KERNEL32.dll_GetLastError
  16 0x0050e258    NONE    FUNC KERNEL32.dll_GetModuleHandleA
  17 0x0050e25c    NONE    FUNC KERNEL32.dll_GetProcAddress
  18 0x0050e260    NONE    FUNC KERNEL32.dll_InitializeCriticalSection
  19 0x0050e264    NONE    FUNC KERNEL32.dll_InterlockedDecrement
  20 0x0050e268    NONE    FUNC KERNEL32.dll_InterlockedExchange
  21 0x0050e26c    NONE    FUNC KERNEL32.dll_InterlockedIncrement
  22 0x0050e270    NONE    FUNC KERNEL32.dll_IsDBCSLeadByteEx
  23 0x0050e274    NONE    FUNC KERNEL32.dll_LeaveCriticalSection
  24 0x0050e278    NONE    FUNC KERNEL32.dll_LoadLibraryA
  25 0x0050e27c    NONE    FUNC KERNEL32.dll_MultiByteToWideChar
  26 0x0050e280    NONE    FUNC KERNEL32.dll_ReleaseSemaphore
  27 0x0050e284    NONE    FUNC KERNEL32.dll_SetLastError
  28 0x0050e288    NONE    FUNC KERNEL32.dll_SetUnhandledExceptionFilter
  29 0x0050e28c    NONE    FUNC KERNEL32.dll_Sleep
  30 0x0050e290    NONE    FUNC KERNEL32.dll_TlsAlloc
  31 0x0050e294    NONE    FUNC KERNEL32.dll_TlsFree
  32 0x0050e298    NONE    FUNC KERNEL32.dll_TlsGetValue
  33 0x0050e29c    NONE    FUNC KERNEL32.dll_TlsSetValue
  34 0x0050e2a0    NONE    FUNC KERNEL32.dll_VirtualProtect
  35 0x0050e2a4    NONE    FUNC KERNEL32.dll_VirtualQuery
  36 0x0050e2a8    NONE    FUNC KERNEL32.dll_WaitForSingleObject
  37 0x0050e2ac    NONE    FUNC KERNEL32.dll_WideCharToMultiByte
   1 0x0050e2b4    NONE    FUNC msvcrt.dll__fdopen
   2 0x0050e2b8    NONE    FUNC msvcrt.dll__fstat
   3 0x0050e2bc    NONE    FUNC msvcrt.dll__lseek
   4 0x0050e2c0    NONE    FUNC msvcrt.dll__read
   5 0x0050e2c4    NONE    FUNC msvcrt.dll__strdup
   6 0x0050e2c8    NONE    FUNC msvcrt.dll__stricoll
   7 0x0050e2cc    NONE    FUNC msvcrt.dll__write
   1 0x0050e2d4    NONE    FUNC msvcrt.dll___getmainargs
   2 0x0050e2d8    NONE    FUNC msvcrt.dll___mb_cur_max
   3 0x0050e2dc    NONE    FUNC msvcrt.dll___p__environ
   4 0x0050e2e0    NONE    FUNC msvcrt.dll___p__fmode
   5 0x0050e2e4    NONE    FUNC msvcrt.dll___set_app_type
   6 0x0050e2e8    NONE    FUNC msvcrt.dll__cexit
   7 0x0050e2ec    NONE    FUNC msvcrt.dll__errno
   8 0x0050e2f0    NONE    FUNC msvcrt.dll__filbuf
   9 0x0050e2f4    NONE    FUNC msvcrt.dll__flsbuf
  10 0x0050e2f8    NONE    FUNC msvcrt.dll__fmode
  11 0x0050e2fc    NONE    FUNC msvcrt.dll__fpreset
  12 0x0050e300    NONE    FUNC msvcrt.dll__fullpath
  13 0x0050e304    NONE    FUNC msvcrt.dll__iob
  14 0x0050e308    NONE    FUNC msvcrt.dll__isctype
  15 0x0050e30c    NONE    FUNC msvcrt.dll__onexit
  16 0x0050e310    NONE    FUNC msvcrt.dll__pctype
  17 0x0050e314    NONE    FUNC msvcrt.dll__setmode
  18 0x0050e318    NONE    FUNC msvcrt.dll_abort
  19 0x0050e31c    NONE    FUNC msvcrt.dll_atexit
  20 0x0050e320    NONE    FUNC msvcrt.dll_atoi
  21 0x0050e324    NONE    FUNC msvcrt.dll_calloc
  22 0x0050e328    NONE    FUNC msvcrt.dll_fclose
  23 0x0050e32c    NONE    FUNC msvcrt.dll_fflush
  24 0x0050e330    NONE    FUNC msvcrt.dll_fopen
  25 0x0050e334    NONE    FUNC msvcrt.dll_fputc
  26 0x0050e338    NONE    FUNC msvcrt.dll_fputs
  27 0x0050e33c    NONE    FUNC msvcrt.dll_fread
  28 0x0050e340    NONE    FUNC msvcrt.dll_free
  29 0x0050e344    NONE    FUNC msvcrt.dll_fseek
  30 0x0050e348    NONE    FUNC msvcrt.dll_ftell
  31 0x0050e34c    NONE    FUNC msvcrt.dll_fwrite
  32 0x0050e350    NONE    FUNC msvcrt.dll_getenv
  33 0x0050e354    NONE    FUNC msvcrt.dll_getwc
  34 0x0050e358    NONE    FUNC msvcrt.dll_iswctype
  35 0x0050e35c    NONE    FUNC msvcrt.dll_localeconv
  36 0x0050e360    NONE    FUNC msvcrt.dll_malloc
  37 0x0050e364    NONE    FUNC msvcrt.dll_mbstowcs
  38 0x0050e368    NONE    FUNC msvcrt.dll_memchr
  39 0x0050e36c    NONE    FUNC msvcrt.dll_memcmp
  40 0x0050e370    NONE    FUNC msvcrt.dll_memcpy
  41 0x0050e374    NONE    FUNC msvcrt.dll_memmove
  42 0x0050e378    NONE    FUNC msvcrt.dll_memset
  43 0x0050e37c    NONE    FUNC msvcrt.dll_putwc
  44 0x0050e380    NONE    FUNC msvcrt.dll_realloc
  45 0x0050e384    NONE    FUNC msvcrt.dll_setlocale
  46 0x0050e388    NONE    FUNC msvcrt.dll_setvbuf
  47 0x0050e38c    NONE    FUNC msvcrt.dll_signal
  48 0x0050e390    NONE    FUNC msvcrt.dll_sprintf
  49 0x0050e394    NONE    FUNC msvcrt.dll_strchr
  50 0x0050e398    NONE    FUNC msvcrt.dll_strcmp
  51 0x0050e39c    NONE    FUNC msvcrt.dll_strcoll
  52 0x0050e3a0    NONE    FUNC msvcrt.dll_strerror
  53 0x0050e3a4    NONE    FUNC msvcrt.dll_strftime
  54 0x0050e3a8    NONE    FUNC msvcrt.dll_strlen
  55 0x0050e3ac    NONE    FUNC msvcrt.dll_strtod
  56 0x0050e3b0    NONE    FUNC msvcrt.dll_strtoul
  57 0x0050e3b4    NONE    FUNC msvcrt.dll_strxfrm
  58 0x0050e3b8    NONE    FUNC msvcrt.dll_tolower
  59 0x0050e3bc    NONE    FUNC msvcrt.dll_towlower
  60 0x0050e3c0    NONE    FUNC msvcrt.dll_towupper
  61 0x0050e3c4    NONE    FUNC msvcrt.dll_ungetc
  62 0x0050e3c8    NONE    FUNC msvcrt.dll_ungetwc
  63 0x0050e3cc    NONE    FUNC msvcrt.dll_vfprintf
  64 0x0050e3d0    NONE    FUNC msvcrt.dll_wcscoll
  65 0x0050e3d4    NONE    FUNC msvcrt.dll_wcsftime
  66 0x0050e3d8    NONE    FUNC msvcrt.dll_wcslen
  67 0x0050e3dc    NONE    FUNC msvcrt.dll_wcstombs
  68 0x0050e3e0    NONE    FUNC msvcrt.dll_wcsxfrm

```

binary contains 3000+ strings, but some of them are interestng:
```
strings crack.bin | grep http
https://sectigo.com/CPS0C
2http://crl.sectigo.com/SectigoRSACodeSigningCA.crl0s
2http://crt.sectigo.com/SectigoRSACodeSigningCA.crt0#
http://ocsp.sectigo.com0'
?http://crl.usertrust.com/USERTrustRSACertificationAuthority.crl0v
3http://crt.usertrust.com/USERTrustRSAAddTrustCA.crt0%
http://ocsp.usertrust.com0
https://www.digicert.com/CPS0
,http://crl3.digicert.com/sha2-assured-ts.crl02
,http://crl4.digicert.com/sha2-assured-ts.crl0
http://ocsp.digicert.com0O
Chttp://cacerts.digicert.com/DigiCertSHA2AssuredIDTimestampingCA.crt0
http://ocsp.digicert.com0C
7http://cacerts.digicert.com/DigiCertAssuredIDRootCA.crt0
4http://crl4.digicert.com/DigiCertAssuredIDRootCA.crl0:
4http://crl3.digicert.com/DigiCertAssuredIDRootCA.crl0P
https://www.digicert.com/CPS0
```

In addition there is some filepath:
```
strings crack.bin | grep Windows
C:\Windows\Microsoft.NET\Framewo
```
### Host / Network activity
After execution it will create > 100 threads and do multiple activities. 
**Host markers**
* File `C:\Windows\Microsoft.NET\Framework\v4.0.30319\AppLaunch.exe`
* Registry `HKLM\System\CurrentControlSet\Control\Session Manager\AppCertDlls`
* Registry `HKLM\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Custom\AppLaunch.exe`
* Boot loader `HKLM\System\CurrentControlSet\Control\SafeBoot\Option`
* DLL `C:\Windows\System32\apphelp.dll`
* FILE `C:\Windows\AppPatch\sysmain.sdb`

Will try to get/read/create `C:\Windows\Microsoft.NET\Framework\v4.0.30319\ui\SwDRM.dll`

**Network makers**
Multiple TCP communications with `193.188.21.73`. According to `https://ipinfo.io/193.188.21.73` - it's russian hosting company

**Conclusion**
Troyan that will create malware files in the system + will add himself to the boot loader (it's all that we can say with basic dynamic analysis).

**Validation**
According to any.run report - analysis is correct: https://any.run/report/548e3a80fe3ef99dbc56b268a1edfde5455b26c166cc0e989b8a67193c981d4b/b0d09550-4a8e-4f6b-9bf7-985fed55767b?_gl=1*1rp5wf4*_ga*MTM3NDg1MTM1Ni4xNjU2MTc0Nzc0*_ga_53KB74YDZR*MTY1NjE3NDc3NC4xLjEuMTY1NjE3NTM4My4zMg..&_ga=2.206414675.1940875027.1656174774-1374851356.1656174774

I was not sure if it's important, but virus will check computer name and supported languages (in the registry)

**Final score**: 9/10

**Epilogue**
According to any.run analysis this binary is a readline password stealer or downloader of readline password stealer (https://resources.infosecinstitute.com/topic/redline-stealer-malware-full-analysis/). I did the right analysis with procmon and wireshark and found almost all activities. But I didn't add language and computer name checks in the win registry.