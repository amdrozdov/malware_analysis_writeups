# Lab1-2 Analysis
### Virus Total Search
**Name**: Trojan/Win32.StartPage.C26214

### Obfuscation
**Packer**: UPX 3.04 NRV. BEST
**Compiler/Linker**: MS VC++ 6.0

diec returns UPX3.04
In addition we can see disassembly in r2:
```asm
r2 lab2.exe
...
[0x00405410]> pdf
        :   ;-- eip:
/ (fcn) entry0 390
|   entry0 ();
|       :   0x00405410      60             pushal
|       :   0x00405411      be00504000     mov esi, 0x405000           ; section.UPX1
|       :   0x00405416      8dbe00c0ffff   lea edi, dword [esi - 0x4000]
|       :   0x0040541c      57             push edi
|      ,==< 0x0040541d      eb0b           jmp 0x40542a
       |:   0x0040541f      90             nop

...
```

**Unpacking**
In order to install UPX on apt-based linux:
```
sudo apt-get install upx-ucl
```

Decompression
```bash
#upx -d Lab01-02.exe -o lab1-2.exe
                       Ultimate Packer for eXecutables
                          Copyright (C) 1996 - 2017
UPX 3.94        Markus Oberhumer, Laszlo Molnar & John Reiser   May 12th 2017

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
     16384 <-      3072   18.75%    win32/pe     lab1-2.exe

Unpacked 1 file.
```

After decompression we can do the analysis
```asm
r2 lab1-2.exe
>>>aaa
>>>afl
0x00401000    1 59           sub.MalService_0
0x00401040    7 265          sub.HGL345_40
0x00401190    3 260          entry0
0x004012a0    1 6            sub.MSVCRT.dll__XcptFilter_2a0
0x004012a6    1 6            sub.MSVCRT.dll__initterm_2a6
0x004012ac    1 18           fcn.004012ac
0x004012c1    1 1            fcn.004012c1
0x004012d6    1 6            sub.MSVCRT.dll__controlfp_2d6
```

### Imports analyss
Checking imports table
```
ii
[0x00401190]> ii
[Imports]
   1 0x00402010    NONE    FUNC KERNEL32.DLL_SystemTimeToFileTime
   2 0x00402014    NONE    FUNC KERNEL32.DLL_GetModuleFileNameA
   3 0x00402018    NONE    FUNC KERNEL32.DLL_CreateWaitableTimerA
   4 0x0040201c    NONE    FUNC KERNEL32.DLL_ExitProcess
   5 0x00402020    NONE    FUNC KERNEL32.DLL_OpenMutexA
   6 0x00402024    NONE    FUNC KERNEL32.DLL_SetWaitableTimer
   7 0x00402028    NONE    FUNC KERNEL32.DLL_WaitForSingleObject
   8 0x0040202c    NONE    FUNC KERNEL32.DLL_CreateMutexA
   9 0x00402030    NONE    FUNC KERNEL32.DLL_CreateThread
   1 0x00402000    NONE    FUNC ADVAPI32.dll_CreateServiceA
   2 0x00402004    NONE    FUNC ADVAPI32.dll_StartServiceCtrlDispatcherA
   3 0x00402008    NONE    FUNC ADVAPI32.dll_OpenSCManagerA
   1 0x00402038    NONE    FUNC MSVCRT.dll__exit
   2 0x0040203c    NONE    FUNC MSVCRT.dll__XcptFilter
   3 0x00402040    NONE    FUNC MSVCRT.dll_exit
   4 0x00402044    NONE    FUNC MSVCRT.dll___p___initenv
   5 0x00402048    NONE    FUNC MSVCRT.dll___getmainargs
   6 0x0040204c    NONE    FUNC MSVCRT.dll__initterm
   7 0x00402050    NONE    FUNC MSVCRT.dll___setusermatherr
   8 0x00402054    NONE    FUNC MSVCRT.dll__adjust_fdiv
   9 0x00402058    NONE    FUNC MSVCRT.dll___p__commode
  10 0x0040205c    NONE    FUNC MSVCRT.dll___p__fmode
  11 0x00402060    NONE    FUNC MSVCRT.dll___set_app_type
  12 0x00402064    NONE    FUNC MSVCRT.dll__except_handler3
  13 0x00402068    NONE    FUNC MSVCRT.dll__controlfp
   1 0x00402070    NONE    FUNC WININET.dll_InternetOpenUrlA
   2 0x00402074    NONE    FUNC WININET.dll_InternetOpenA
```

**Analysis**
1. `0x00402070    NONE    FUNC WININET.dll_InternetOpenUrlA
2. `0x00402074    NONE    FUNC WININET.dll_InternetOpenA``

Network activity with http handler and opening a http or ftp resource [based on msdn](https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetopenurla)

In addition we can see some threading and time libs:
```
8 0x0040202c    NONE    FUNC KERNEL32.DLL_CreateMutexA
   9 0x00402030    NONE    FUNC KERNEL32.DLL_CreateThread
   1 0x00402000    NONE    FUNC ADVAPI32.dll_CreateServiceA
   2 0x00402004    NONE    FUNC ADVAPI32.dll_StartServiceCtrlDispatcherA
   3 0x00402008    NONE    FUNC ADVAPI32.dll_OpenSCManagerA
```

Interesting function: `StartServiceCtrlDispatcherA` - Connects the main thread of a service process to the service control manager, which causes the thread to be the service control dispatcher thread for the calling process.

**Conclusion**
Most probably the programm will download some code, run createProcess and will attach it to the service dispatcher

### Host or Network activity

Checking the entry code:
```asm
>>>pdf entry0
|           0x00401260      8b4de0         mov ecx, dword [local_20h]
|           0x00401263      8908           mov dword [eax], ecx
|           0x00401265      ff75e0         push dword [local_20h]
|           0x00401268      ff75d4         push dword [local_2ch]
|           0x0040126b      ff75e4         push dword [local_1ch]
|           0x0040126e      e88dfdffff     call sub.MalService_0
|           0x00401273      83c430         add esp, 0x30               ; '0'
|           0x00401276      8945dc         mov dword [local_24h], eax
|           0x00401279      50             push eax
|           0x0040127a      ff1540204000   call dword [sym.imp.MSVCRT.dll_exit] ; 0x402040
```
Checking MalService0 call
```
>>>pdf @0x00401000
(fcn) sub.MalService_0 59
|   sub.MalService_0 ();
|           ; var int local_8h @ esp+0x8
|           ; var int local_ch @ esp+0xc
|           ; var int local_10h @ esp+0x10
|              ; CALL XREF from 0x0040126e (entry0)
|           0x00401000      83ec10         sub esp, 0x10               ; [00] m-r-x section size 4096 named .text
|           0x00401003      8d442400       lea eax, dword [esp]
|           0x00401007      c74424001030.  mov dword [esp], str.MalService ; [0x403010:4]=0x536c614d ; "MalService"
|           0x0040100f      50             push eax
|           0x00401010      c74424084010.  mov dword [local_8h], sub.HGL345_40 ; [0x401040:4]=0x400ec81
|           0x00401018      c744240c0000.  mov dword [local_ch], 0
|           0x00401020      c74424100000.  mov dword [local_10h], 0
|           0x00401028      ff1504204000   call dword [sym.imp.ADVAPI32.dll_StartServiceCtrlDispatcherA] ; 0x402004 ; "L\""
|           0x0040102e      6a00           push 0
|           0x00401030      6a00           push 0
|           0x00401032      e809000000     call sub.HGL345_40
|           0x00401037      83c418         add esp, 0x18
\           0x0040103a      c3             ret
```
This function creates windows service for function `sub.HGL345_40`

Checking the sub function:
```
pdf @0x00401040
|           0x004010a0      6a00           push 0
|           0x004010a2      51             push ecx
|           0x004010a3      6a00           push 0
|           0x004010a5      6a02           push 2                      ; 2
|           0x004010a7      6a10           push 0x10                   ; 16
|           0x004010a9      6a02           push 2                      ; 2
|           0x004010ab      681c304000     push str.Malservice         ; 0x40301c ; "Malservice"
|           0x004010b0      681c304000     push str.Malservice         ; 0x40301c ; "Malservice"
|           0x004010b5      56             push esi
|           0x004010b6      ff1500204000   call dword [sym.imp.ADVAPI32.dll_CreateServiceA] ; 0x402000 ; "<\""

```

It will register and start the service `Malservice`.

In addition we can find url `http://www.malwareanalysisbook.com`
using `strings` tool.

**Conclusion**
The software will register and start a malware service on target machine, most probabbly will have some network activity with `http://www.malwareanalysisbook.com`